# =============================================================================
# apache-listener.conf -- Apache Configuration for FPP Eavesdrop
# =============================================================================
# Deployed to: /etc/apache2/conf-available/listener.conf
# Enabled via: a2enconf listener
#
# Two purposes:
#   1. Directory permissions: AllowOverride All lets .htaccess work (captive portal)
#   2. WebSocket proxy: routes /ws on port 80 to ws-sync-server.py on port 8080
# =============================================================================

# Allow .htaccess files in the FPP web root (needed for captive portal redirect).
# Also allows directory listing and symlink following (needed for /music/ symlink).
<Directory /opt/fpp/www>
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# Override FPP's aggressive caching for captive portal files.
# FPP sets ExpiresDefault "access plus 1 year" which caches ALL responses
# (including our CAPPORT API) for a year. The captive portal API must NOT
# be cached -- phones need a fresh response on every WiFi connection.
<IfModule mod_headers.c>
    <LocationMatch "^/listen/(portal-api|capport|detect)\.php$">
        Header set Cache-Control "private, no-store, max-age=0"
        Header unset Expires
    </LocationMatch>
</IfModule>

# WebSocket reverse proxy: client connects to ws://<host>/ws on port 80,
# Apache upgrades the connection and proxies it to the Python WebSocket
# server running on localhost:8080.
# This is essential because phones on the captive portal can only access port 80.
# Requires: mod_proxy + mod_proxy_wstunnel (enabled by install.sh)
ProxyPass /ws ws://127.0.0.1:8080/
ProxyPassReverse /ws ws://127.0.0.1:8080/
