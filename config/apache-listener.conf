# =============================================================================
# apache-listener.conf -- Apache Configuration for SBS with Audio Sync
# =============================================================================
# Deployed to: /etc/apache2/conf-available/listener.conf
# Enabled via: a2enconf listener
#
# Purposes:
#   1. Captive portal redirect for listener APs (via IncludeOptional)
#   2. Cache control for captive portal API responses
#   3. WebSocket proxy: routes /ws on port 80 to ws-sync-server.py on port 8080
#
# IMPORTANT: Rewrite rules live in show-rewrite.conf (auto-generated by
# listener-ap.sh) and are included here via IncludeOptional. This file lives
# in conf-enabled which FPP does NOT regenerate â€” unlike 000-default.conf
# which FPP overwrites, wiping any changes we inject there.
# =============================================================================

# --- Captive portal rewrite rules for listener APs ---
# show-rewrite.conf uses <Location /> blocks with RewriteEngine On.
# <Location> is processed AFTER <Directory>, so our rules get the final say
# even though FPP's <Directory /opt/fpp/www/> has AllowOverride None.
# The file is auto-generated by listener-ap.sh based on roles.json.
# If no listener APs exist, the file won't exist (IncludeOptional handles this).
IncludeOptional /home/fpp/listen-sync/show-rewrite.conf

# Override FPP's aggressive caching for captive portal files.
# FPP sets ExpiresDefault "access plus 1 year" which caches ALL responses
# (including our CAPPORT API) for a year. The captive portal API must NOT
# be cached -- phones need a fresh response on every WiFi connection.
<IfModule mod_headers.c>
    <LocationMatch "^/listen/(portal-api|capport|detect)\.php$">
        Header set Cache-Control "private, no-store, max-age=0"
        Header unset Expires
    </LocationMatch>
</IfModule>

# WebSocket reverse proxy: client connects to ws://<host>/ws on port 80,
# Apache upgrades the connection and proxies it to the Python WebSocket
# server running on localhost:8080.
# This is essential because phones on the captive portal can only access port 80.
# Requires: mod_proxy + mod_proxy_wstunnel (enabled by install.sh)
ProxyPass /ws ws://127.0.0.1:8080/
ProxyPassReverse /ws ws://127.0.0.1:8080/
