<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Show Audio</title>
  <style>
    :root{
      --bg:#0f1115;
      --card:#171a21;
      --ink:#e9eef7;
      --muted:#9aa6b2;
      --accent:#00e5ff;
      --bad:#ff4d4d;
      --ok:#4dff88;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
    .wrap{ max-width:720px; margin:0 auto; padding:18px; }
    .header{ text-align:center; margin:10px 0 18px; }
    .header img{ width:86px; height:86px; border-radius:18px; box-shadow:0 8px 28px rgba(0,0,0,.35); }
    h1{ margin:12px 0 6px; font-size:34px; letter-spacing:.3px; color:var(--accent); }
    .sub{ margin:0; color:var(--muted); font-size:14px; }
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:16px; margin-top:16px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .card:first-of-type{ margin-top:0; }
    .section-title{ margin:0 0 10px; font-size:16px; color:var(--accent); }
    button{
      font-size:16px; padding:12px 16px; border-radius:12px;
      border:2px solid var(--accent); background:#11141a; color:var(--ink);
      cursor:pointer; width:100%;
    }
    button:active{ transform:scale(.99); }
    button:disabled{ opacity:.5; cursor:default; }
    .row{ display:flex; gap:10px; margin-top:10px; }
    .row button{ width:50%; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px; padding:8px 12px; color:var(--muted); font-size:13px;
      background:rgba(0,0,0,.18);
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#666; }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--bad); }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
    .kv{ background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px 12px; }
    .k{ font-size:12px; color:var(--muted); }
    .v{ margin-top:4px; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .small{ margin-top:12px; font-size:12px; color:var(--muted); line-height:1.4; }
    .footer{ margin-top:14px; text-align:center; font-size:12px; color:var(--muted); opacity:.85; }
    audio{ width:100%; margin-top:12px; }
    select{
      width:100%; font-size:16px; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--ink);
      cursor:pointer;
    }
    input[type="password"]{
      width:100%; font-size:16px; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--ink);
    }
    .btn-sm{ font-size:14px; padding:10px 14px; margin-top:10px; }
    .status-msg{ margin-top:8px; font-size:12px; padding:8px; border-radius:8px; display:none; }
    .status-msg.success{ background:rgba(77,255,136,.15); color:var(--ok); }
    .status-msg.error{ background:rgba(255,77,77,.15); color:var(--bad); }
    .opts-toggle{
      text-align:center; cursor:pointer; padding:12px;
      background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.06);
      border-radius:12px; color:var(--muted); font-size:13px;
    }
    .opts-toggle:hover{ background:rgba(0,0,0,.22); }
    .opts-body{ display:none; margin-top:12px; }
    .opts-body.open{ display:block; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <img src="logo.png" alt="Undocumented Engineer" />
    <h1>Show Audio</h1>
    <p class="sub">Keep this page open during the show. Tap anywhere to enable audio.</p>
  </div>

  <!-- Playback Control — always visible -->
  <div class="card">
    <h3 class="section-title">Playback</h3>
    <select id="seqSelect"><option value="">Loading...</option></select>
    <div class="row">
      <button id="startSeq">Start</button>
      <button id="stopSeq">Stop</button>
    </div>
    <div id="seqStatus" class="status-msg"></div>
  </div>

  <!-- Sync Status -->
  <div class="card">
    <div class="row" style="margin-top:0;">
      <button id="mute">Mute</button>
      <button id="resync">Resync</button>
    </div>

    <span class="pill" style="margin-top:12px; display:inline-flex;"><span id="dot" class="dot"></span><span id="state">Idle</span></span>

    <audio id="player" preload="auto" playsinline></audio>

    <div class="grid">
      <div class="kv"><div class="k">Track</div><div class="v" id="track">&mdash;</div></div>
      <div class="kv"><div class="k">Error</div><div class="v" id="err">&mdash;</div></div>
      <div class="kv"><div class="k">Rate</div><div class="v" id="rate">&mdash;</div></div>
      <div class="kv"><div class="k">Poll</div><div class="v" id="poll">&mdash;</div></div>
    </div>

    <div class="small">
      If audio is silent on iPhone, check the ringer switch and volume.
      You may need to stay on this page (some phones pause background audio).
    </div>

    <div class="footer" id="ver">Version: (loading&hellip;)</div>
  </div>

  <!-- Options — collapsible, WiFi password only if wlan1 present -->
  <div class="card" id="optionsCard" style="display:none;">
    <div class="opts-toggle" id="optsToggle">&#9660; Options</div>
    <div class="opts-body" id="optsBody">
      <div id="wifiSection">
        <h3 class="section-title" style="margin-top:12px;">WiFi AP Password</h3>
        <p class="small" style="margin-top:0;">Change the SHOW_AUDIO access point password (8-63 characters).</p>
        <input type="password" id="newPass" placeholder="New password" autocomplete="new-password">
        <button class="btn-sm" id="changePass">Change Password</button>
        <div id="passStatus" class="status-msg"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ====== Config ======
  const STATUS_URL = "./status.php";
  const POLL_MS = 250;
  const HARD_SEEK_S = 1.0;
  const SEEK_COOLDOWN_MS = 2000;

  // ====== UI refs ======
  const dot = document.getElementById("dot");
  const stateEl = document.getElementById("state");
  const trackEl = document.getElementById("track");
  const errEl = document.getElementById("err");
  const rateEl = document.getElementById("rate");
  const pollEl = document.getElementById("poll");
  const verEl = document.getElementById("ver");
  const muteBtn = document.getElementById("mute");
  const resyncBtn = document.getElementById("resync");
  const audio = document.getElementById("player");

  // ====== State ======
  let audioUnlocked = false;
  let muted = false;
  let currentBase = "";
  let pollTimer = null;
  let haveMetadata = false;
  let lastSeekMs = 0;

  // Clock offset estimation
  let clockOffset = 0;
  let clockOffsetValid = false;
  const OFFSET_HISTORY_SIZE = 8;
  let offsetHistory = [];

  function setDot(mode){
    dot.classList.remove("ok","bad");
    if(mode==="ok") dot.classList.add("ok");
    if(mode==="bad") dot.classList.add("bad");
  }

  function setState(text, ok){
    stateEl.textContent = text;
    setDot(ok ? "ok" : (ok===false ? "bad" : ""));
  }

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  // ====== Audio unlock on first user interaction ======
  function unlockAudio(){
    if(audioUnlocked) return;
    audioUnlocked = true;
    try {
      audio.muted = true;
      const p = audio.play();
      if(p && typeof p.then === 'function'){
        p.then(() => { audio.pause(); audio.currentTime = 0; audio.muted = false; })
         .catch(() => { audio.muted = false; });
      } else {
        audio.muted = false;
      }
    } catch(_){ audio.muted = false; }
  }
  document.addEventListener("click", unlockAudio, { once: true });
  document.addEventListener("touchstart", unlockAudio, { once: true });

  // ====== Clock offset ======
  function updateClockOffset(serverMs, clientSendMs, rtt){
    const sample = serverMs - clientSendMs - (rtt / 2);
    offsetHistory.push(sample);
    if(offsetHistory.length > OFFSET_HISTORY_SIZE) offsetHistory.shift();
    const sorted = [...offsetHistory].sort((a,b) => a - b);
    const median = sorted[Math.floor(sorted.length / 2)];
    if(!clockOffsetValid){
      clockOffset = median;
      clockOffsetValid = true;
    } else {
      clockOffset = clockOffset * 0.7 + median * 0.3;
    }
  }

  // ====== Compute FPP target position in seconds ======
  function getTargetSec(msg){
    const nowMs = Date.now();
    const serverMs = Number(msg.server_ms);
    const rawPosMs = Number(msg.pos_ms || 0);
    let targetMs = rawPosMs;
    if(Number.isFinite(serverMs) && serverMs > 1e12 && Math.abs(nowMs - serverMs) < 300000){
      let elapsed = clockOffsetValid ? ((nowMs + clockOffset) - serverMs) : (nowMs - serverMs);
      if(!Number.isFinite(elapsed)) elapsed = 0;
      elapsed = clamp(elapsed, 0, 1500);
      targetMs = rawPosMs + elapsed;
    }
    return targetMs / 1000.0;
  }

  // ====== Sync ======
  function sync(msg){
    trackEl.textContent = msg.base || "\u2014";

    // --- Stop state: pause and reset ---
    if(msg.state === "stop" || !msg.base){
      if(!audio.paused) audio.pause();
      audio.currentTime = 0;
      audio.playbackRate = 1.0;
      currentBase = "";
      haveMetadata = false;
      setState("Idle", null);
      errEl.textContent = "\u2014";
      rateEl.textContent = "\u2014";
      return;
    }

    // --- Pause state ---
    if(msg.state === "pause"){
      if(!audio.paused) audio.pause();
      audio.playbackRate = 1.0;
      setState("Paused", true);
      return;
    }

    // --- Playing ---
    setState("Playing", true);

    // Track change — load new source
    if(msg.base && msg.base !== currentBase){
      currentBase = msg.base;
      haveMetadata = false;
      audio.src = msg.mp3_url || "";
      audio.load();
      audio.addEventListener("loadedmetadata", function onMeta(){
        audio.removeEventListener("loadedmetadata", onMeta);
        haveMetadata = true;
      });
      return;
    }

    // Wait for metadata
    if(!haveMetadata || !Number.isFinite(audio.duration) || audio.duration <= 0) return;

    const targetSec = getTargetSec(msg);
    const localSec = audio.currentTime || 0;
    const errSec = targetSec - localSec;

    errEl.textContent = (errSec >= 0 ? "+" : "") + (errSec * 1000).toFixed(0) + " ms";
    rateEl.textContent = audio.playbackRate.toFixed(3) + "x";

    const absErr = Math.abs(errSec);
    const nowMs = Date.now();

    if(absErr > HARD_SEEK_S && (nowMs - lastSeekMs) > SEEK_COOLDOWN_MS){
      audio.currentTime = clamp(targetSec, 0, Math.max(0, audio.duration - 0.1));
      audio.playbackRate = 1.0;
      lastSeekMs = nowMs;
      if(audio.paused && audioUnlocked) audio.play().catch(() => {});
      return;
    }

    if(audio.paused && audioUnlocked) audio.play().catch(() => {});
    audio.playbackRate = 1.0;
  }

  // ====== Polling ======
  async function tick(){
    const t0 = Date.now();
    try {
      const r = await fetch(STATUS_URL + "?ts=" + t0, { cache: "no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      const msg = await r.json();
      const t1 = Date.now();
      const rtt = t1 - t0;
      pollEl.textContent = rtt + " ms";

      if(msg.server_ms && rtt > 0 && rtt < 500){
        updateClockOffset(msg.server_ms, t0, rtt);
      }

      sync(msg);
    } catch(e){
      setState("Disconnected", false);
    }
  }

  function startPolling(){
    if(pollTimer) return;
    pollTimer = setInterval(tick, POLL_MS);
    tick();
  }

  // ====== UI events ======
  muteBtn.addEventListener("click", () => {
    muted = !muted;
    muteBtn.textContent = muted ? "Unmute" : "Mute";
    audio.muted = muted;
  });

  resyncBtn.addEventListener("click", () => {
    if(!haveMetadata || !currentBase) return;
    lastSeekMs = 0;
  });

  // Fetch version
  fetch("./version.php?t=" + Date.now()).then(r => r.text()).then(t => {
    verEl.textContent = "Version: " + (t || "").trim();
  }).catch(() => { verEl.textContent = "Version: unknown"; });

  // Start polling immediately
  startPolling();

  // ====== Admin: Playback Controls ======
  function showStatus(el, msg, ok){
    el.textContent = msg;
    el.className = "status-msg " + (ok ? "success" : "error");
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 5000);
  }

  async function adminPost(data){
    const fd = new FormData();
    for(const k in data) fd.append(k, data[k]);
    const r = await fetch("./admin.php", { method: "POST", body: fd });
    return await r.json();
  }

  const seqSelect = document.getElementById("seqSelect");
  const startSeqBtn = document.getElementById("startSeq");
  const stopSeqBtn = document.getElementById("stopSeq");
  const seqStatus = document.getElementById("seqStatus");

  // Load playlists + sequences on page load
  (async function loadSequences(){
    try {
      const res = await adminPost({ action: "get_sequences" });
      if(!res.success) return;
      seqSelect.innerHTML = '<option value="">-- Select --</option>';
      if(Array.isArray(res.playlists) && res.playlists.length > 0){
        const grp = document.createElement("optgroup");
        grp.label = "Playlists";
        res.playlists.forEach(s => {
          const o = document.createElement("option");
          o.value = s; o.textContent = s;
          grp.appendChild(o);
        });
        seqSelect.appendChild(grp);
      }
      if(Array.isArray(res.sequences) && res.sequences.length > 0){
        const grp = document.createElement("optgroup");
        grp.label = "Sequences";
        res.sequences.forEach(s => {
          const o = document.createElement("option");
          o.value = s; o.textContent = s;
          grp.appendChild(o);
        });
        seqSelect.appendChild(grp);
      }
      // Show Options card only if wlan1 exists
      if(res.has_wlan1){
        document.getElementById("optionsCard").style.display = "";
      }
    } catch(e){ seqSelect.innerHTML = '<option value="">Failed to load</option>'; }
  })();

  startSeqBtn.addEventListener("click", async () => {
    const seq = seqSelect.value;
    if(!seq){ showStatus(seqStatus, "Select a playlist or sequence first", false); return; }
    startSeqBtn.disabled = true; startSeqBtn.textContent = "Starting...";
    try {
      const res = await adminPost({ action: "start_sequence", sequence: seq });
      showStatus(seqStatus, res.success ? "Started: " + seq : (res.error || "Failed"), res.success);
    } catch(e){ showStatus(seqStatus, "Network error", false); }
    startSeqBtn.disabled = false; startSeqBtn.textContent = "Start";
  });

  stopSeqBtn.addEventListener("click", async () => {
    stopSeqBtn.disabled = true; stopSeqBtn.textContent = "Stopping...";
    try {
      const res = await adminPost({ action: "stop_playback" });
      showStatus(seqStatus, res.success ? "Stopped" : (res.error || "Failed"), res.success);
    } catch(e){ showStatus(seqStatus, "Network error", false); }
    stopSeqBtn.disabled = false; stopSeqBtn.textContent = "Stop";
  });

  // ====== Options: WiFi Password ======
  const optsToggle = document.getElementById("optsToggle");
  const optsBody = document.getElementById("optsBody");
  optsToggle.addEventListener("click", () => {
    const open = optsBody.classList.toggle("open");
    optsToggle.innerHTML = open ? "&#9650; Options" : "&#9660; Options";
  });

  const newPassInput = document.getElementById("newPass");
  const changePassBtn = document.getElementById("changePass");
  const passStatus = document.getElementById("passStatus");

  changePassBtn.addEventListener("click", async () => {
    const pw = newPassInput.value;
    if(pw.length < 8 || pw.length > 63){
      showStatus(passStatus, "Password must be 8-63 characters", false); return;
    }
    changePassBtn.disabled = true; changePassBtn.textContent = "Changing...";
    try {
      const res = await adminPost({ action: "change_password", password: pw });
      if(res.success){
        showStatus(passStatus, "Password changed! Reconnect with new password.", true);
        newPassInput.value = "";
      } else {
        showStatus(passStatus, res.error || "Failed", false);
      }
    } catch(e){ showStatus(passStatus, "Network error", false); }
    changePassBtn.disabled = false; changePassBtn.textContent = "Change Password";
  });
})();
</script>
</body>
</html>
