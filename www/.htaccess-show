# =============================================================================
# .htaccess-show — Captive Portal + Security Whitelist for SBS+ Show AP
# =============================================================================
#
# Template deployed by listener-ap.sh with placeholder substitution:
#   __SHOW_AP_IP__        → Show AP IP (e.g., 192.168.60.1)
#   __SHOW_SUBNET_ESC__   → Escaped subnet prefix (e.g., 192\.168\.60\.)
#   __SHOW_SUBNET_OCTET__ → Third octet (e.g., 60) for admin subnet exclusion
#
# Deployed to: /opt/fpp/www/.htaccess when SBS+ show AP is enabled
# Removed when show AP is disabled or service stops
#
# PURPOSE:
#   When a phone connects to the show AP WiFi, it tries to detect if it
#   has internet access. Because wildcard DNS resolves ALL domains to the
#   show AP IP, these requests hit Apache. This .htaccess intercepts them
#   and redirects to /listen/listen.html (the public listen-only page).
#
# SECURITY MODEL:
#   Requests from the show subnet are restricted to public-safe paths only:
#     Allowed: /listen/listen.html, status.php, version.php, portal-api.php,
#              detect.php, logo*.png, /music/, /ws
#     Blocked: /listen/admin.html, /listen/admin.php, /api/, /settings/, etc.
#   All other sources (eavesdrop AP, localhost, eth0) get full FPP access.
#
# RULE ORDER (processed top to bottom, first match wins):
#   1. Captive portal detection URLs from show subnet → redirect
#   2. Whitelisted paths from show subnet → allow (pass through)
#   3. Everything else from show subnet → redirect to listen.html
#   4. All other sources → pass through (full FPP access, no rules needed)
#
# =============================================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # --- Rule 1: Captive portal detection URLs from show network ---
    # Phones check specific URLs/hosts to detect captive portals.
    # We intercept these and redirect to the public listen page.
    # Uses REMOTE_ADDR (not HTTP_HOST) to reliably identify show network clients.
    #
    # Matched URLs/hosts:
    #   Android/Chrome: generate_204, gen_204, connectivitycheck.gstatic.com
    #   Apple iOS/macOS: hotspot-detect.html, success.html, captive.apple.com
    #   Windows: connecttest.txt, msftconnecttest.com
    #   Firefox/Ubuntu: canonical.html
    RewriteCond %{REMOTE_ADDR} ^__SHOW_SUBNET_ESC__
    RewriteCond %{REQUEST_URI} ^/(generate_204|gen_204|hotspot-detect\.html|success\.html|success\.txt|connecttest\.txt|canonical\.html|ncsi\.txt|redirect)$ [NC,OR]
    RewriteCond %{HTTP_HOST} ^(captive\.apple\.com|connectivitycheck\.gstatic\.com|connectivitycheck\.android\.com|clients[0-9]\.google\.com|www\.msftconnecttest\.com|msftconnecttest\.com|msftncsi\.com)$ [NC]
    RewriteRule ^ http://__SHOW_AP_IP__/listen/listen.html [R=302,L]

    # --- Rules 2a-d: Whitelist allowed paths from show network ---
    # These rules use [L] (Last) to stop processing — the request passes through
    # to the actual file/directory without any redirect.

    # 2a. Allow specific public files under /listen/
    #     listen.html (the page), status.php (sync), version.php (version info),
    #     portal-api.php (RFC 8908), detect.php (legacy portal), logo images
    RewriteCond %{REMOTE_ADDR} ^__SHOW_SUBNET_ESC__
    RewriteCond %{REQUEST_URI} ^/listen/(listen\.html|status\.php|version\.php|portal-api\.php|detect\.php|logo[^/]*\.png)$ [NC]
    RewriteRule ^ - [L]

    # 2b. Allow /music/ (audio files served from FPP's music directory)
    RewriteCond %{REMOTE_ADDR} ^__SHOW_SUBNET_ESC__
    RewriteCond %{REQUEST_URI} ^/music(/|$) [NC]
    RewriteRule ^ - [L]

    # 2c. Allow /ws (WebSocket proxy — Apache routes this to ws-sync on port 8080)
    RewriteCond %{REMOTE_ADDR} ^__SHOW_SUBNET_ESC__
    RewriteCond %{REQUEST_URI} ^/ws$ [NC]
    RewriteRule ^ - [L]

    # 2d. Allow favicon.ico (prevents redirect loops in some browsers)
    RewriteCond %{REMOTE_ADDR} ^__SHOW_SUBNET_ESC__
    RewriteCond %{REQUEST_URI} ^/favicon\.ico$ [NC]
    RewriteRule ^ - [L]

    # --- Rule 3: Block everything else from show network ---
    # Any path not in the whitelist above (e.g., /listen/admin.html,
    # /listen/admin.php, /api/, /settings/) gets redirected to listen.html.
    # This protects FPP's admin interface and the eavesdrop admin page.
    # Also catches wildcard domain requests (phone tried to load google.com
    # but DNS resolved it to the show AP IP).
    RewriteCond %{REMOTE_ADDR} ^__SHOW_SUBNET_ESC__
    RewriteRule ^ http://__SHOW_AP_IP__/listen/listen.html [R=302,L]

    # --- Rule 4: All other sources pass through ---
    # Eavesdrop AP clients, localhost, eth0, fpp.local get full FPP access.
    # No rule needed — requests that don't match the show subnet proceed normally.
</IfModule>
